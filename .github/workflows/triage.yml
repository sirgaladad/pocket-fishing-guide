name: Green Team AI Triage

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    if: github.event.label.name == 'user-feedback'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Classify and Triage Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const title = issue.title || '';
            const body = issue.body || '';
            const text = (title + ' ' + body).toLowerCase();

            let prefix = '[Feedback]';
            let classification = 'General Feedback';
            let impact = 'Low';
            let effort = 'S';
            let recommendation = 'Backlog';

            if (/broken|crash|error|not working|bug|fail|404|blank|missing/.test(text)) {
              prefix = '[Bug]';
              classification = 'Bug';
              impact = 'High';
              effort = 'M';
              recommendation = 'Sprint';
            } else if (/request|feature|add|would love|wish|suggestion|improve|enhancement/.test(text)) {
              prefix = '[Feature]';
              classification = 'Feature Request';
              impact = 'Med';
              effort = 'M';
              recommendation = 'Backlog';
            } else if (/confusing|hard to find|layout|design|ux|ui|interface|navigation|unclear/.test(text)) {
              prefix = '[UX]';
              classification = 'UX Feedback';
              impact = 'Med';
              effort = 'S';
              recommendation = 'Backlog';
            }

            const cleanTitle = title.replace(/^\[(Bug|Feature|UX|Feedback)\]\s*/i, '');
            const newTitle = prefix + ' ' + cleanTitle;

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              title: newTitle
            });
            console.log('Title updated to: ' + newTitle);

            const lines = [
              '## ðŸŸ¢ Green Team AI Triage Report',
              '',
              '| Field | Value |',
              '|-------|-------|',
              '| ðŸ·ï¸ Classification | ' + classification + ' |',
              '| ðŸ“Š Impact | ' + impact + ' |',
              '| ðŸ“ Effort | ' + effort + ' |',
              '| ðŸ”— Parent Epic | None |',
              '| âœ… Recommendation | ' + recommendation + ' |',
              '',
              '---',
              '*Triaged automatically by ðŸŸ¢ Green Team AI. Handing off to Red Team for human review.*',
              '',
              '@sirgaladad â€” this issue is classified and ready for your review.'
            ];

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: lines.join('\n')
            });
            console.log('Green Team comment posted.');

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'user-feedback'
              });
            } catch(e) { console.log('Remove label: ' + e.message); }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['red-team']
            });
            console.log('Labels swapped: user-feedback -> red-team');

            const PROJECT_ID = 'PVT_kwHOCLdsC84BPLJ1';
            const STATUS_FIELD_ID = 'PVTSSF_lAHOCLdsC84BPLJ1zg9qSU4';
            const HUMAN_REVIEW_OPTION_ID = '118dfdf1';

            const itemQuery = await github.graphql(`
              query {
                repository(owner: "${context.repo.owner}", name: "${context.repo.repo}") {
                  issue(number: ${issue.number}) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id title }
                      }
                    }
                  }
                }
              }
            `);

            const projectItems = itemQuery.repository.issue.projectItems.nodes;
            const targetItem = projectItems.find(n => n.project.id === PROJECT_ID);

            if (targetItem) {
              await github.graphql(`
                mutation {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: "${PROJECT_ID}"
                    itemId: "${targetItem.id}"
                    fieldId: "${STATUS_FIELD_ID}"
                    value: { singleSelectOptionId: "${HUMAN_REVIEW_OPTION_ID}" }
                  }) {
                    projectV2Item { id }
                  }
                }
              `);
              console.log('Project board status updated to Human Review');
            } else {
              console.log('Issue not yet on project board, skipping status update');
            }

            console.log('Triage complete for issue #' + issue.number);
